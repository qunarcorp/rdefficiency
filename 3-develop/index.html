<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Part 3 开发提效, “基于云原生的研发效能实战”">
    <meta name="description" content="
第五章    开发提效5.1    BFF5.1.1    背景大前端中心拥有大量的前端工程，带有 应用 的 node 端工程200+，qzz + rn + 小程序工程300+。当前的现状是疫情影响、人力紧张、需求堆积较多、前端人力维护现">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Part 3 开发提效 | 去哪儿旅行</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/rdefficiency/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/rdefficiency/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/rdefficiency/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/rdefficiency/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/rdefficiency/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/rdefficiency/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/rdefficiency/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/rdefficiency/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?ce84511d3df71640a9378a69f6293044";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

    

    <script>
        (function(){
        var src = "https://jspassport.ssl.qhimg.com/11.0.1.js?d182b3f28525f2db83acfaaf6e696dba";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
        })();
    </script>

<meta name="generator" content="Hexo 6.0.0"><link rel="stylesheet" href="/rdefficiency/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/rdefficiency/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/rdefficiency/" class="waves-effect waves-light">
                    
                    <img src="/rdefficiency/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">去哪儿旅行</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/rdefficiency/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/rdefficiency/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/rdefficiency/contact" class="waves-effect waves-light">
            
            <i class="fa fa-comments"></i>
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/rdefficiency/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">去哪儿旅行</div>
        <div class="logo-desc">
            
            北京趣拿软件科技有限公司 | 基础架构
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/rdefficiency/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/rdefficiency/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/rdefficiency/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-comments"></i>
                
                留言板
            </a>
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    
<script src="/rdefficiency/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/rdefficiency/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/rdefficiency/medias/featureimages/cover.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Part 3 开发提效
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/rdefficiency/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                        <a href="/rdefficiency/tags/%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87/" target="_blank">
                            <span class="chip bg-color">开发效率</span>
                        </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-10-10
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    北京趣拿软件科技有限公司 ｜ 基础架构
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    11.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    38 分
                </div>
                
                

                
                <div id="busuanzi_container_page_pv" class="info-break-policy">
                    <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                    <span id="busuanzi_value_page_pv"></span>
                </div>
                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><img src="/rdefficiency/medias/images/cover_part/part_c.jpg" alt=""></p>
<h1 id="第五章-开发提效"><a href="#第五章-开发提效" class="headerlink" title="第五章    开发提效"></a>第五章    开发提效</h1><h2 id="5-1-BFF"><a href="#5-1-BFF" class="headerlink" title="5.1    BFF"></a>5.1    BFF</h2><h3 id="5-1-1-背景"><a href="#5-1-1-背景" class="headerlink" title="5.1.1    背景"></a>5.1.1    背景</h3><p>大前端中心拥有大量的前端工程，带有 应用 的 node 端工程200+，qzz + rn + 小程序工程300+。当前的现状是疫情影响、人力紧张、需求堆积较多、前端人力维护现有工程已经捉襟见肘。如何在当前人力紧张的情况下，服务好用户、做好用户体验的前提下高效的维护好这些工程，那么提效就是我们的主要抓手，除了之前已经做过的低代码平台以外，我们如何继续提效，如何找到低成本的方案进行大幅提效成为我们迫在眉睫的核心诉求。</p>
<p>我们首先分析了当前会影响到前端效率的一些问题点，梳理下来主要有以下一些问题：</p>
<ol>
<li>UI 逻辑处理争议（比如代金券的状态有待领取、已领取、已作废、已过期等状态，状态是后端计算得到的，不同状态展示不同，站在后端角度不需要关心前端 UI、站在前端角度不同状态展示不同希望有人给算好展示相关的数据和样式，前端可直接渲染，由于低代码的组件是跨业务复用的，不同业务的后端立场不同，接口返回也会有差异，前端后端关于UI逻辑处理存在争议）</li>
<li>多接口数据整合争议（有些业务场景下前端一个组件的数据是由后端多个团队提的接口，接口整合工作的划分也存在争议）</li>
<li>相同代码在不同前端工程存在多份（由于有些情况下前端无法说服后端去做相关数据处理逻辑，那么大量数据处理逻辑就放在了前端，前端可能不同端、不同 team 都会用到某接口数据都需要进行数据处理，这种场景下相同前端的数据处理逻辑代码就散落在不同的工程代码库中）</li>
<li>前端同质化 node 服务多（有些情况下，为了前端为了搞一个服务于前端的服务来方便前端开发，前端会自建 node 服务，各个 node 服务其实处理的事情大致是相同的，但是每个场景下都单独建立了各自的服务）</li>
</ol>
<p>以上的问题在不同项目中不断重复的影响着前端的开发效率，所以我们的目标就聚焦到了：梳理一个可以解决以上问题的合适方案。</p>
<h3 id="5-1-2-方案选型"><a href="#5-1-2-方案选型" class="headerlink" title="5.1.2    方案选型"></a>5.1.2    方案选型</h3><p>下图5-1是我们对于整体方案的核心诉求和行业内的解决方案。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/bff-01.png" alt=""></p>
<center>5-1 诉求和解决方案</center>

<p>我们希望整体方案，可以完全自控、代码安全不托管、保持 DevOps 不变，且能数据处理逻辑改动后够按照线上的 case 数据自动化的回归测试，我们对比的国内阿里云，和国外亚马逊的 AWS Lambda 都无法满足，所以我们走了自研的方案。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/BFF-02.png" alt=""></p>
<center>5-2    方案对比</center>

<p>核心点是开发、构建、测试、发布、线上问题排查等去哪儿都有自己的一套完整流程。首先业界的都做的比较完善，功能齐全，能满足我们的基本诉求。其次，问题排查，目前我司的排查问题整体链路已经非常明确，工具也相对完善，通过用户名、手机号可以看到每一个节点的数据输出，如果使用了外界的产品，这一部分的数据输出就是个黑匣子，会给我们排查问题增加很大的难度。最后，自动化测试，去哪儿内部的一些用户输入输出我们是可以拿到的并进行真实 case 自动化测试的，但是如果使用外界产品，无法拿到线上真实案例。</p>
<p>所以这里核心点我们主要是借鉴业界的思想，进行自研实现。</p>
<p>我们的方案核心思想总结为一句话就是：以 Serverless 思想，搭建 BFF 层，建设一个 FAAS 服务平台，前端人员在平台上写云函数即可完成业务开发，不需要关心服务器端知识、不需要搭建工程，可以云端复用，可以进行自动化的线上 case 验证。</p>
<h3 id="5-1-3方案详解"><a href="#5-1-3方案详解" class="headerlink" title="5.1.3方案详解"></a>5.1.3方案详解</h3><p>整个方案的核心可以用以下这张图5-3进行概况，接下来进行详细的展开介绍。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/bff-03.png" alt=""></p>
<center>5-3    解决思路</center>

<p>整个方案，以 Serverless 思想，搭建 BFF 层，建设一个 FAAS 服务平台，定位的角色是服务层，边界是处理数据、但不处理 dom。</p>
<ol>
<li><p>易用性：前端人员可零成本的上手使用、在线调试，无需额外的学习成本。</p>
</li>
<li><p>问题排查全链路可回溯：从发起端到后续各个环节可以可视化查看全链路调用，进行精确定位，也可根据关键信息，查询各个节点输入输出，也可以根据线上 case 还原回溯调试处理逻辑。</p>
</li>
<li><p>代码跨工程复用：由于运行先服务端，不受端的限制，云函数可自由复用。</p>
</li>
<li><p>自动化的线上 case 验证：修改云函数代码后可根据线上 case 数据，自动进行回归验证。</p>
</li>
<li><p>高性能&amp;高可用：作为统一的服务，对应搞性能高可用也有较高的要求。</p>
</li>
</ol>
<h3 id="5-1-4-架构讲解"><a href="#5-1-4-架构讲解" class="headerlink" title="5.1.4    架构讲解"></a>5.1.4    架构讲解</h3><ul>
<li>系统架构</li>
</ul>
<p>系统架构如下图5-4：</p>
<p><img src="/rdefficiency/medias/images/cloudbase/bff-04.png" alt=""></p>
<center>5-4    系统架构图</center>

<p>整个架构两条分支对应了两种场景：</p>
<ol>
<li>第一种后端站在服务端的角度认为数据很合适，但是前端认为不合适，后端接口数据需要处理下，给前端用的。</li>
<li>第二种需要 BFF 层去组合多接口的场景</li>
</ol>
<ul>
<li>BFF 架构</li>
</ul>
<p>BFF 架构如下图5-5：</p>
<p><img src="/rdefficiency/medias/images/cloudbase/bff-05.png" alt=""></p>
<center>5-5    BFF架构图</center>

<ol>
<li><p>BFF 的界面配置层用公司内的低代码系统搭建平台进行搭建。</p>
</li>
<li><p>服务层主要使用容器化部署方式支持方便支持自动扩缩容。</p>
</li>
<li><p>持久化存储采用 MySQL 关系型数据库进行存储。</p>
</li>
</ol>
<h3 id="5-1-5-系统介绍"><a href="#5-1-5-系统介绍" class="headerlink" title="5.1.5    系统介绍"></a>5.1.5    系统介绍</h3><ul>
<li>配置系统</li>
</ul>
<p>配置系统主要可以进行单函数、编排的在线编写维护工作。系统单函数管理界面如下图5-6。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/bff-06.png" alt=""></p>
<center>5-6    配置界面</center>


<p>系统编排管理界面入下图5-7。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/bff-07.png" alt=""></p>
<center>5-7    系统编排管理界面</center>

<ul>
<li>单函数介绍</li>
</ul>
<p>单函数的使用场景：对于较为简单的数据处理可以使用单函数。单函数规范如下图5-8。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/bff-08.png" alt=""></p>
<center>5-8    单函数语法</center>

<p>其中语法检查主要利用 babel 进行校验，避免常规错误，比如：返回 promise 的函数前面必须跟 await，函数必须有返回值，不能有声明但未使用的变量等。</p>
<ul>
<li>编排介绍</li>
</ul>
<p>编排的使用场景：组件多、数据节点多层级深、依赖接口多、整体逻辑复杂等场景下，适合使用编排进行逻辑的拆分和组装处理，可以降低单函数的复杂度，增加复用性。编排结构如下图5-9：</p>
<p><img src="/rdefficiency/medias/images/cloudbase/bff-09.png" alt=""></p>
<center>5-9    编排语法</center>

<p>编排的执行过程如下图5-10：</p>
<p><img src="/rdefficiency/medias/images/cloudbase/bff-10.png" alt=""></p>
<center>5-10    编排执行流程</center>

<ul>
<li>平台能力</li>
</ul>
<ol>
<li><p>平台主要提供了以下6中通用能力，供开发者在编写函数时进行调用。</p>
</li>
<li><p>函数调用的能力，可通过 getHandle 传入函数标识，进行函数调用。</p>
</li>
<li><p>获取配置中心配置文件的能力，通过 getQConfig 方法进行配置文件获取。</p>
</li>
<li><p>可以进行 redis 操作，通过 redis 对象进行 redis 操作。</p>
</li>
<li><p>进行请求，通过 request 进行请求。</p>
</li>
<li><p>通过logger对象进行，日志打印操作。</p>
</li>
<li><p>中断编排执行，可通过 composeBreak 进行编排的中断。</p>
</li>
</ol>
<ul>
<li>版本方案</li>
</ul>
<p>我们的会有 beta、仿真、线上3种环境，版本方案如何选择，我们的核心期望是：版本一致、开发易用、方案清晰。最终我们的方案如下图5-11。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/bff-11.png" alt=""></p>
<center>5-11 版本更新方案</center>

<p>如图5-12，多人协作时类似git版本管理，每个人可独自产生小beta版本进行各种开发，最终merge的放进行合并上线。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/bff-12.png" alt=""></p>
<center>5-12 协作模式</center>

<ul>
<li>易用性设计</li>
</ul>
<p>为了提升易用性，我们的平台支持以下几方面的内容：</p>
<ol>
<li><p><strong>全链路问题定位</strong></p>
<p>线上的一个请求我们可以通过traceId串联起各个调用环境和输入输出，可视化的方式进行展示，也可以按照关键信息进行各个环节的日志查询。</p>
</li>
<li><p><strong>在线调试</strong></p>
</li>
<li><p>我们可以根据 traceId 进行线上数据调试，也可以自己伪造mock数据进行在线调试。</p>
</li>
<li><p><strong>搜索定位</strong></p>
<p>代码可搜索定位。</p>
</li>
<li><p><strong>引用函数跳转</strong></p>
<p>类似本地编辑器可以按住 ctrl 建点击跳转到引用的函数体中。</p>
</li>
<li><p><strong>服务器端能力抹平</strong></p>
<p>我们的编辑器是在 web 浏览器端运行的，但是打日志、配置文件的读取等能力操作是必须运行在node服务端的，为了给开发者屏蔽掉这个区别，方案直接在线编写、在线运行调试看效果，我们进行了服务端能力抹平。</p>
</li>
<li><p><strong>可视化流程图</strong></p>
<p>编排中函数关系又可视化的流程图进行展示。</p>
</li>
</ol>
<ul>
<li>性能安全高可用</li>
</ul>
<p>为了保障整体服务的安全高可用，我们做了以下功能。</p>
<ol>
<li><p>代码在线 CR</p>
</li>
<li><p>多环境验证</p>
</li>
<li><p>线上真实 case 自动化回归测试</p>
</li>
<li><p>上线审核</p>
</li>
<li><p>支持限流配置</p>
</li>
<li><p>服务双环境秒切</p>
</li>
</ol>
<h3 id="5-1-6-落地效果"><a href="#5-1-6-落地效果" class="headerlink" title="5.1.6    落地效果"></a>5.1.6    落地效果</h3><ul>
<li>系统性能</li>
</ul>
<p>落地系统性能，如下图5-13，单函数、编排执行耗时 P90 优化到了 10ms 以下：</p>
<p><img src="/rdefficiency/medias/images/cloudbase/13.png" alt=""></p>
<center>5-13    落地系统性能</center>

<ul>
<li>接入场景</li>
</ul>
<p>目前主要的接入场景：</p>
<ol>
<li>营销活动：双旦集卡、五一大促、中秋、十一大促等。</li>
<li>门票主流程：POI 货架、POI 头部、L 页。</li>
<li>酒店 neeko 标签系统：neeko 标签系统是展示在酒店D页酒店卡片上的标签数据。</li>
</ol>
<ul>
<li>接入效果</li>
</ul>
<p>门票接入效果和接入页面如下图5-14：</p>
<p><img src="/rdefficiency/medias/images/cloudbase/14.png" alt=""></p>
<center>5-14    接入页面效果</center>

<ul>
<li><p><strong>代码层面</strong></p>
<ul>
<li><p>2w行降至6500+行</p>
</li>
<li><p>更专注于展示</p>
</li>
</ul>
</li>
<li><p><strong>迭代效率</strong></p>
<ul>
<li><p>不需要发QP包</p>
</li>
<li><p>不需要QA</p>
</li>
<li><p>1pd -&gt; 十几分钟</p>
</li>
</ul>
</li>
<li><p>酒店 D 页标签处理逻辑，从 neeko 标签系统迁入 BFF 效果</p>
<ul>
<li><p>P99 从 400ms 降低到 152ms 降低72%</p>
</li>
<li><p>P50 从 96ms 降低到 24ms 降低75%</p>
</li>
</ul>
</li>
</ul>
<h3 id="5-1-7-未来展望"><a href="#5-1-7-未来展望" class="headerlink" title="5.1.7    未来展望"></a>5.1.7    未来展望</h3><p>未来规划主要有一些5方面的事情可以落地继续推进：</p>
<ol>
<li><p>缓存预热，减少缓存冷启动带来的性能损耗。</p>
</li>
<li><p>自动扩缩容。</p>
</li>
<li><p>在线修改记录查看。</p>
</li>
<li><p>业务接入&amp;推广。</p>
</li>
<li><p>按业务进行集群物理隔离，避免某个业务影响全局的问题出现。</p>
</li>
</ol>
<h2 id="5-2-CMS"><a href="#5-2-CMS" class="headerlink" title="5.2    CMS"></a>5.2    CMS</h2><h3 id="5-2-1-背景"><a href="#5-2-1-背景" class="headerlink" title="5.2.1    背景"></a>5.2.1    背景</h3><p>去哪儿网在旅游行业，拥有庞大的用户群体，除了日常的购票之外，我们也想和用户做更多的触达，让用户感受到平台的温度，这个触达主要分为三个部分：</p>
<ol>
<li><p><strong>日常的促销</strong></p>
<p>比如机票、酒店购买完毕，可以抽奖、发起砍价拿现金等活动，增加用户的粘性，切实给用户带来实惠。</p>
</li>
<li><p><strong>新客的引导</strong></p>
<p>app 端和小程序都有新人专区，有各式各样的活动、任务引导用户购票转化。</p>
</li>
<li><p><strong>节日活动</strong></p>
<p>逢年过节时，平台会推出大力度的促销活动，进一步的提高用户转化，提高品牌影响力。</p>
</li>
</ol>
<p>上面主要的三个场景，去哪儿网各业务线也都有对应的产品运营团队来负责，那么问题来了，触达用户是需要页面的，如此高频度，大规模的页面，该如何产生呢？</p>
<h3 id="5-2-2-解决方案"><a href="#5-2-2-解决方案" class="headerlink" title="5.2.2    解决方案"></a>5.2.2    解决方案</h3><p>如果按照常规的项目实施流程，成本和周期都是无法满足需求的，我们先畅想下方案，再看落地的问题：</p>
<ol>
<li><strong>页面数量多</strong> - 走复用思路，不必每个页面都重新开发。</li>
<li><strong>变动频率高</strong> - 支持配置化，不必每次变动都重新发布。</li>
</ol>
<p>第1个问题，如果要走复用思路，就要对营销的不同场景进行抽象，并且和 UI 同学达成设计上的规范统一，进而达成页面风格的统一。</p>
<p>第2个问题，如果要支持配置化，首先需要对页面组件可变化的点进行预先设计，这样一来才能够把这些做成配置选型，集成到系统里面去。</p>
<p>所以说到这里，非常明确需要技术人员去落地的东西就出来了：</p>
<ol>
<li><p>设计一套系统允许开发人员将组件开发好，然后集成到系统，运营人员可以在系统里灵活组装出自己想要的页面。</p>
</li>
<li><p>页面上线之后，如果有修改的点，允许运营人员在系统里对组件配置项进行修改，并且预览，效果好了，就推到线上。</p>
</li>
</ol>
<h3 id="5-2-3-系统设计"><a href="#5-2-3-系统设计" class="headerlink" title="5.2.3     系统设计"></a>5.2.3     系统设计</h3><ul>
<li>页面管理系统</li>
</ul>
<p>要想使得页面配置化上线，首先我们需要设计一个页面管理系统，允许对组件进行拖放、编辑，来完成页面的组装和上线。</p>
<p>这个系统如图5-15所示，我们给他命名为：CMS=Component Management System ——组件管理系统，和行业的” CMS “内容管理系统略有不同，接下来都用 CMS 来简化表述。</p>
<p>组件是 CMS 系统最为宝贵的素材，我们的愿景和实际行动也是按照如下理念去做的：</p>
<p><strong>页面不是开发出来的，页面是组装出来的，运营可以根据组件库灵活的去组装，组件库的每一次迭代都在为运营赋能。</strong></p>
<p><img src="/rdefficiency/medias/images/cloudbase/components.png" alt=""></p>
<center>5-15    运营管理配置系统</center>

<ul>
<li><strong>开发组件接入</strong></li>
</ul>
<p>组件是需要迭代的，一个组件的生命周期是：开发-&gt;测试-&gt;部署-&gt;集成→运营使用，中间不可避免的需要修改，因此整个链路需要精心进行设计。</p>
<ul>
<li><strong>面临的问题</strong></li>
</ul>
<p>业务众多、组件数目多，如果都在一个工程进行迭代，势必会越来越臃肿，所以我们设计了分布式工程开发方案，就是开发人员可以自己建一个 git 工程，然后集成到主系统。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/coworker.png" alt=""></p>
<center>5-16 协作模式</center>

<p>对于开发完成的组件，可以自行发布，到主系统进行集成：</p>
<p><img src="/rdefficiency/medias/images/cloudbase/flows.png" alt=""></p>
<center>5-17</center>

<p>组件集成完毕，我们可以在营销分类管理界面将需要的组件都集成进来：</p>
<p><img src="/rdefficiency/medias/images/cloudbase/mix.png" alt=""></p>
<center>5-18 组件组装</center>

<p>这样一来运营同学就可以在组件列表里看到这些组件，直接拖放到页面，进行编辑上线了。</p>
<ul>
<li><strong>页面渲染系统</strong></li>
</ul>
<p>关于页面渲染，分为主要三种情况：</p>
<ol>
<li>app 端内渲染，hybrid 支持离线包。</li>
<li>H5 浏览器端，支持服务端渲染。</li>
<li>小程序端渲染，天然离线包模式。</li>
</ol>
<p><img src="/rdefficiency/medias/images/cloudbase/drawing.png" alt=""></p>
<center>5-19 页面渲染系统</center>

<p>如此，各个端我们都争取到了较好的渲染效果，这其中每一步都有一些问题需要解决：</p>
<ol>
<li><p><strong>app 端内渲染</strong></p>
<p>我们在打包资源的同时，要考虑运营修改配置实时生效，那么 node 端页面承载系统，就要支持这种延后请求配置的情况。还有断网时候，自动使用上一次配置，降级渲染。</p>
</li>
<li><p><strong>H5 浏览器端</strong></p>
<p>如果对于性能要求高的场景，可以把模板同步到 node 端，这样会计算好最终的 html 返回给浏览器，直接进行渲染。</p>
</li>
<li><p><strong>小程序端</strong></p>
<p>代码打包出来是以原生模式渲染，天然离线包模式，也做了断网时候，自动使用上一次配置，降级渲染。</p>
</li>
</ol>
<h3 id="5-2-4-演进之路"><a href="#5-2-4-演进之路" class="headerlink" title="5.2.4    演进之路"></a>5.2.4    演进之路</h3><p>最初的 CMS 系统页面只支持 H5 端的渲染，并不支持小程序端原生渲染。随着去哪儿网砍价项目的逐步发展，会有当前页弹出授权、订阅、分享等一系列和原生能力打通的诉求，如果是 H5 运行在小程序里，那么势必要做一个原生中间页去承载，这种第一是方案复杂、第二用户体验也不好，于是才有了下面的探索。</p>
<ul>
<li><strong>多端渲染</strong></li>
</ul>
<p>因此我们需要去探索一种基于一套源码，在微信小程序端也能按照原生方式去渲染的方案，于是调研了如下几种方案：</p>
<p><img src="/rdefficiency/medias/images/cloudbase/scheme.png" alt=""></p>
<center>5-20    方案选型</center>

<p>综合成本和工程、组件现状，最终采用了自研的方式，将 CMS 组件以原生方式运行在小程序端，基本的思路是在两端分别开发一个容器，这个容器在会在运行时将组件的调用都适配到小程序端。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/applet.png" alt=""></p>
<center>5-21 小程序渲染</center>

<p>毕竟是截然不同的两个端，中间页遇到了非常多的细节问题，目前均已解决：</p>
<p><img src="/rdefficiency/medias/images/cloudbase/problems.png" alt=""></p>
<center>5-22 多端问题及解决方案</center>

<ul>
<li><strong>关于性能</strong></li>
</ul>
<p>小程序端更新页面的方式就是 setData，那么对于复杂的页面，setData 会导致渲染卡顿，参考官方输欧盟：</p>
<p><em><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/performance/tips.html">https://developers.weixin.qq.com/miniprogram/dev/framework/performance/tips.html</a></em></p>
<p>因此 CMS 采取的方案是，使用微信的 Component，这样一来可以做到局部刷新，即便是页面组件比较多，性能也可以优化控制。</p>
<p>关于 CMS 组件自动适配到 Component，主要涉及到一个组件动态包装问题，具体按照小程序的规范，感兴趣可以看下官方文档：</p>
<p><em><a href="https://developers.weixin.qq.com/miniprogram/dev/reference/api/Component.html">https://developers.weixin.qq.com/miniprogram/dev/reference/api/Component.html</a></em></p>
<p>它的生命周期是比较复杂且特殊的，因此需要在 CMS 小程序容器端对这些生命周期进行磨平，setState 到 setData 进行自动转换，这两个问题解决，基本就适配了。</p>
<ul>
<li><strong>风险控制</strong></li>
</ul>
<p>有人操作的场景就会存在风险，尤其对于已经在线的页面，每一次组件属性的配置、组件皮肤的调整都有可能引起故障，那么站在系统维度，我们做了如下事情：</p>
<ol>
<li><p><strong>组件遵循版本管理</strong></p>
<p>也就是说开发增加了一个新版本，对于线上已有页面，除非运营主动点击更新，否则是不会使用最新版本的，这样可以降低页面呲掉的风险。</p>
</li>
<li><p><strong>组件属性编辑校验</strong></p>
<p>对于一个组件来说，有些属性是必填的，有些属性必须是满足某个格式的，那么如果没有一个约束，就可能会导致页面呲掉，所以组件属性允许配置校验规则，可以一定程度规避这个问题。</p>
</li>
<li><p><strong>页面配置草稿箱</strong></p>
<p>每一次修改默认都是进草稿箱，只要不点击上线，那么就不可能影响到线上页面。</p>
</li>
<li><p><strong>页面上线需要审核</strong></p>
<p>对于重点页面，每一次点击上线，都需要审核，审核人可以在系统 diff 变化的部分，进行测试校验，通过之后才能最终上线。</p>
</li>
<li><p><strong>系统运维完善</strong></p>
<p>页面组件的渲染率，JS 代码执行的错误，以及图片等资源加载错误情况，统一接入实时监控，确保尽可能主动发现线上问题。</p>
</li>
</ol>
<ul>
<li><strong>流程沉淀</strong></li>
</ul>
<p>系统体系搭建起来了，那么要想发挥真正的复用价值，还需要依赖流程的规范化；如果需求没有统一的一个收口，那么还是会导致组件的重复开发。所以如下四方的协作关系需要做一个规定：</p>
<ol>
<li><p><strong>运营</strong></p>
<p>需求基本都来自于运营，运营同学有了需求之后，如果是简单的会直接提报给设计，如果复杂的会提报给产品，当然有时候也会直接找技术。</p>
</li>
<li><p><strong>设计</strong></p>
<p>对展示和交互需求进行统一把关，初步决策是否复用现有组件。</p>
</li>
<li><p><strong>产品</strong></p>
<p>对功能和逻辑需求进行统一把关，初步决策是否复用现有组件。</p>
</li>
<li><p><strong>技术</strong></p>
<p>结合三方的诉求和建议，以及组件代码设计角度，给出进一步建议，是否复用，以及复用的改造程度；如三方有争议，还是会结合场景具体分析决策。</p>
</li>
</ol>
<p>有了流程，覆盖到大部分场景，但是实际中会有绕过、跳步的情况，所以技术这边最终的把关就非常重要。设计、产品、技术三方收到需求，对于有争议的及时升级其他两方确认，也非常的主要。</p>
<h3 id="5-2-5-效果总结"><a href="#5-2-5-效果总结" class="headerlink" title="5.2.5    效果总结"></a>5.2.5    效果总结</h3><ul>
<li><strong>成本角度</strong></li>
</ul>
<p>去哪儿网此前有三套营销前台管理系统，随着机酒事业群的诞生，CMS 经历了一期、二期的迭代，已经能够将机票、酒店、市场的营销需求接入进来，统一了设计、开发、运营流程。</p>
<p>带来的直观效果就是维护系统的人员变少了，设计同学专注于组件皮肤的设计，精力也得到了释放，运营同学有大量可复用组件，上活动频次也更高了。</p>
<p>除了日常的营销上线之外，融合之后上线了：双镇店铺、999秒杀、十一大促三个重点项目，抽奖、秒杀、代金券、货架组件在这三个里面都得到了复用，尤其是 机票、市场、酒店三个业务的十一大促活动，做到了0开发，直接配置上线。</p>
<ul>
<li><strong>体验角度</strong></li>
</ul>
<ol>
<li><p>体验一致性：此前三套系统，背后的 UI 团队也不同，那么雷同组件皮肤也不一致，伴随着 UI 团队的统一，页面展示效果一致性更好了。</p>
</li>
<li><p>页面可用性：在同一套系统收口，CMS 在 app 离线包和小程序离线包场景都做了降级渲染处理，以及图片加载自动重试等优化，提升弱网环境体验。</p>
</li>
</ol>
<ul>
<li><strong>承载业务</strong></li>
</ul>
<p>系统目前承载了 机票、酒店、市场的砍价业务，每天为平台拉来了大量的新客，赢免单、话费充值、支付后抽奖等高频次业务，以及机票的日常航司运营活动、酒店、玩乐的日常运营活动，都可以运营自主配置上线。</p>
<h3 id="5-2-6-后续规划"><a href="#5-2-6-后续规划" class="headerlink" title="5.2.6    后续规划"></a>5.2.6    后续规划</h3><p>经历了 CMS 一期、二期迭代之后，在组件覆盖、系统并发及风险控制方面，都得到了保障。但是最终这个事情要想比较圆满，势必要满足如下几点：</p>
<ol>
<li>开发成本大幅度降低。</li>
<li>UI 设计成本大幅度降低。</li>
<li>运营成本大幅度降低。</li>
</ol>
<p>面对1和2，因为复用了，成本自然降低了；但是由于某些组件配置比较复杂（比如秒杀、货架、代金券等），运营同学在使用起来还是比较吃力，所以我们设了一个感性的目标：</p>
<p><strong>运营顺畅度提升</strong></p>
<p>如果运营配置起来，很顺畅，那意味着用时更少了，自然这个问题就不存在了，而提升运营顺畅度，不仅限于组件属性的优化，我们计划：</p>
<ol>
<li>组件添加、删除、修改基础操作顺畅度。</li>
<li>组件属性简化、汉化、手册同步配备。</li>
<li>能够快速的找到想要的组件，充分发挥自己的想象力。</li>
</ol>
<p>服务于营销，唯一不变的就是变化；对于营销而言，任重而道远，营销的场景也是多变且复杂的，我们必须时刻保持敏感、如履薄冰，对系统进行优化，才能够更好的服务于用户，赋能营销。</p>
<h2 id="5-3-云开发实践"><a href="#5-3-云开发实践" class="headerlink" title="5.3    云开发实践"></a>5.3    云开发实践</h2><h3 id="5-3-1-背景"><a href="#5-3-1-背景" class="headerlink" title="5.3.1    背景"></a>5.3.1    背景</h3><ul>
<li>我们遇到的问题</li>
</ul>
<p>在云原生的落地过程，serverless 是很重要的一个课题，它能让开发同学免去繁琐的服务器搭建和运维工作，轻松的实现功能的迭代和交付。云开发是目前serverless 架构的经典实践，因此我们基于此进行了探索。</p>
<p>去哪儿网拥有大量的前端工程，数以百记的前端工程代码，对于前端工程师来说如何在当前疫情严重、人力紧张、不熟悉项目的情况下，如何能够随时随地快速着手开发并发布项目？对于团队来说如何保证团队配置化的统一，让开发者按照规范工作？</p>
<p>带着这些问题，参考云原生实践，我们实现了去哪儿网云开发平台，面向业务场景提供了标准的容器化的开发环境，对开发者来说大大提升了便捷性。我们取得的成果主要有：</p>
<ol>
<li>对于首次启动项目并开发来说提效80%。</li>
<li>对于日常开发维护的项目提效60%。</li>
</ol>
<p>本文会重点阐述云原生背景下云开发带给开发者的优势，以及去哪儿网云开发整体的技术方案以及产品实践。以下这些场景开发同学应该经常遇到：</p>
<ol>
<li>当我们要对一个新项目修复bug时，很可能代码改写只需要5min，但安装环境花了两小时。</li>
<li>作为一个新人，或者说接手一个新项目的时候，按文档教程安装环境，项目依旧跑不起来。这个有可能就是某个依赖的版本安装的不匹配或是文档没有及时更新。</li>
<li>前后端联调时，我们前端总是需要发beta版本才能让后端和产品同事看到页面效果。如果有一些需要频繁修改的内容，那么发版就是一个很大的时间成本。</li>
<li>当我们休假的时候，为了保障业务的稳定，必须得带着办公的电脑，那如果现在有一种方案可以不需要那么合适的设备即可办公，是不是就解决了24h 待机的问题。</li>
</ol>
<p>以上都是我们在传统开发中常见的问题，我们的云开发就是为了解决这些问题出现的。</p>
<ul>
<li>传统开发VS云开发</li>
</ul>
<p><img src="/rdefficiency/medias/images/cloudbase/01.jpg" alt=""></p>
<center>图5-23 传统开发 VS 云开发</center>

<p>如图5-23所示，左边这一侧是传统开发的流程，可以看到，它的工作区重心是在本地，需要开发者自己去安装  IDE 安装、搭建依赖环境、自己去 gitlab 上拉取代码，然后开发完成后再去到发布平台去发布。</p>
<p>而云开发呢，相对于传统开发，它的工作区重心从本地转移到了 server 端。开发者无需去关心 IDE 安装、代码拉取，更重要的是环境依赖安装，这一步呢其实就解决了我们先前提出的环境安装问题。同时，在 server 端启动服务后，会对外暴露一个服务的地址，这个地址可以在内网环境被所有人访问，这样的话，也就免去了每次都要发 beta 版本联调的问题。那对于开发者来说，本地只需要一个浏览器即可。我们不需要那么合适的设备即可快速上手开发。</p>
<p>从以上可以看出，云开发相对于本地开发有着一些独特的优势，接下来我们详细总结归纳一下。</p>
<ul>
<li>云开发优势</li>
</ul>
<p><img src="/rdefficiency/medias/images/cloudbase/02.jpg" alt=""></p>
<center>图5-24 云开发优势</center>

<p>如图5-24，云开发的优势可以分为4个方面：</p>
<ol>
<li><p><strong>解决运行环境问题</strong></p>
<p>云开发环境会根据业务场景提前预置需要的依赖，而这另一方面也保证了团队之间的环境一致性，从而避免因为环境导致的一系列问题。</p>
</li>
<li><p><strong>探索云时代团队协作的新模式</strong></p>
<p>怎么做到团队配置化的统一，怎么让开发者按照我们的规范去工作。比如当团队协作开发时，我们每个人本地安装的环境版本是否一样，也是一个非常重要的开发问题，即便你的开发环境有很详细的文档，也很难把所有的细节都写清楚。</p>
<p>举一个例子，像前端同学经常用的 npm 包，发版会很频繁，如果同步只能是群里发公告，然后其他同学再去更新，一来一去增加了非常大的时间沟通成本。那如果用了云开发，就能避免这些问题。</p>
</li>
<li><p><strong>闭合整个研发链路</strong></p>
<p>像我们公司团队很多，各个平台层出不穷，开发过程中往往会伴随多个平台的切换，将IDE嵌入浏览器，同时整合各个研发平台，这样的话避免反复切换平台带来的繁琐与不便。</p>
</li>
<li><p><strong>便捷性</strong></p>
<p>像在疫情之下，难免会有远程办公的情况，云开发让我们不必需要合适的设备即可写代码，这对便利性也是极大地提升。我们开发同学随时创建随时上手开发。</p>
</li>
</ol>
<p>所以综合来看，不论对个人还是企业来说，云开发都有着非常大的优势，这些很大程度上可以提升开发效率，助力研发效能。基于公司容器化基础设施，再加上业内开源产品的背景下，为了解决本地开发环境等一系列问题，我们去哪儿开启了自己的云开发时代。</p>
<h3 id="5-3-2-整体方案"><a href="#5-3-2-整体方案" class="headerlink" title="5.3.2    整体方案"></a>5.3.2    整体方案</h3><p>在了解云开发有这么多的优势之后，接下来我们从去哪儿的角度看实践过程中云开发上的一些理念和方案。这个理念总结来说就是并不是纯粹从一个技术和工具的视角去看待，而更多的是从业务需求/业务场景的视角，我们看怎么能够把这个技术给用好，并且以此需要做什么样的技术创新。</p>
<ul>
<li>系统整体架构</li>
</ul>
<p><img src="/rdefficiency/medias/images/cloudbase/03.png" alt=""></p>
<center>图5-25 云开发系统架构</center>

<p>如图5-25所示，系统整体架构划分为三部分：开发者本地、远程 server 端以及管理系统。</p>
<p>开发者在本地使用浏览器通过 https 来访问远程 server 端，那在 server 端我们是基于公司 k8s 集群搭建的，会针对不同业务场景设计相应的镜像，从而实例化容器，这个容器的工作区包含 了webIDE、开发环境和代码等等，这一块就是相当于给用户提供了一套标准的开发环境。最后一部分就是管理平台，包含了对webIDE 的管理、文件资源的持久化、开发者的权限和其他平台的整合等。</p>
<p>接下来我们分块讲解下我们在做的过程中的一些方案抉择。</p>
<ul>
<li>webIDE选型</li>
</ul>
<p>实现云开发需要借助一个非常重要的产品— webIDE ， webIDE 简单概括就是只需要一个浏览器，就能编写代码，调试代码，甚至是发布代码。</p>
<p>虽然 webIDE 本身还未流行，但是在各大云厂商，各大国内大厂均已有落地产品，谈不上一个比较新的技术，而且实现方案，也基本明确成熟，这里挑几个业内有代表性的产品进行介绍。</p>
<ol>
<li><p><strong><a href="https://github.com/eclipse-theia/theia">Theia</a></strong></p>
<p>Eclipse 推出的云端和桌面 IDE 平台，star 数有17.3K，完全开源。Theia 是基于 VS Code 开发的，它的模块化特性非常适合二次开发，比如 gitpod ，华为云 CloudIDE 、阿里系 IDE 便是基于 Theia 开发。</p>
</li>
<li><p><strong><a href="https://github.com/coder/code-server">Code-server</a></strong></p>
<p>Code-server 是由 Coder 开发的，它的理念是把 VSCode 搬到了浏览器上。目前 star 数有56.6K，个人版是开源的。</p>
<p>vscode 是基于 electron 架构，大家都知道 electron 它的 UI 最终是运行在 chrome 浏览器中，这整个和 web 架构在 UI 层是天然相通的。其次 vscode 底层架构源是 typescript ，那 typescript 对于前端同学是相对于比较熟悉的，对于我们后面进行一些源码结构改造提供很好的可拓展性和可定制性。</p>
<p>vscode 有个最大的优点，它为什么能够发展到现在这个程度，其实和他的插件机制是有关系的。vscode 本身的功能其实不是很多，其他的功能都是以插件化的方式插入到 vscode 里面去。</p>
</li>
<li><p><strong><a href="https://stackblitz.com/">stackblitz</a></strong></p>
<p>stackblitz 是一款非常方便写 demo 的 IDE 。提供了非容器化方案的纯前端 node 环境，可以说非常有价值。整体来讲，其技术方案的优点在于不消耗远程资源，但是缺点，一是不开源，二是毕竟是模拟的 node 环境，在系统的一些层面可能会有所缺失。</p>
</li>
<li><p><strong><a href="https://jetbrains.github.io/projector-client/mkdocs/latest/">JetBrains Projector</a></strong></p>
<p>JetBrains Projector 是 JetBrains 提出的“远程开发”解决方案，基于 Client + Server 架构。star 数有1k，也是开源的，但最近 JetBrains Projector 作为自己的独立产品的开发已暂停，但 Projector 仍然是 JetBrains Gateway 的重要组成部分，因此官方建议从 Projector 切换到 Gateway。</p>
</li>
</ol>
<ul>
<li><strong>小结</strong></li>
</ul>
<p>不管是从 star 数，还是开源，拓展性角度来说，code-server 优点是我们初期阶段选择它作为 webIDE 的原因。当然其实对于 webIDE 这一层，是完全可拓展的和可更换的，这个下面讲镜像架构的时候会提及。</p>
<h3 id="5-3-3-本地容器-VS-k8s-集群"><a href="#5-3-3-本地容器-VS-k8s-集群" class="headerlink" title="5.3.3    本地容器 VS k8s 集群"></a>5.3.3    本地容器 VS k8s 集群</h3><p>确定好了 webIDE ，接下来就需要考虑 webIDE 部署在哪，是通过容器的方式部署在用户本地呢还是部署在公司统一管理的 k8s 集群上呢？</p>
<p>那我们就来对比下这两种方案的优缺点：</p>
<ol>
<li><p><strong>本地容器</strong></p>
<p>docker 启动在开发者本地，对于开发者来讲使用的自由度高，但随之而来的是不利于统一管理。对于电脑的配置也要求比较高，而且 docker 对于我们前端同学来讲也是一个比较大的学习成本。</p>
</li>
<li><p><strong>k8s集群</strong></p>
<p>它的优点在于便于团队之间的协作开发，且利于公司统一管理，而且不需要依赖于特定的设备，最主要的是我们开发同学不需要额外学习关于容器化的知识，上手比较快。</p>
</li>
</ol>
<p>所以最终我们选择 K8s 集群管理模式。</p>
<h3 id="5-3-4-镜像架构设计"><a href="#5-3-4-镜像架构设计" class="headerlink" title="5.3.4    镜像架构设计"></a>5.3.4    镜像架构设计</h3><p>确定好了容器部署，接下来需要设计镜像，因为容器是基于镜像创建的，是由镜像实例化而来的。在设计镜像时，我们是从业务场景出发来梳理的。</p>
<p>起初，我们是先为 cms 低代码场景定制的，原因是它短频快的开发模式和云开发即开即用的特性很契合，cms 业务覆盖面大，像机票、酒店、火车票、市场等各业务线都在使用，而且入手难度低，再加上考虑到其他场景的拓展性，比如说 qrn、node、h5 这些，通过分析这些场景使用的依赖的异同点，我们设计出了下图5-26的镜像架构图。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/04.jpg" alt=""></p>
<center>图5-26 云开发镜像架构图</center>

<p>容器镜像按照分层设计分为了4层：</p>
<ol>
<li><p><strong>业务场景层</strong></p>
<p>目前已经提供 cms qrn node &amp; qzz 等多个场景。这些基本满足了我们公司常用的一些前端场景。那如果后续有想使用云开发的其他业务场景，也可以继续拓展。 </p>
</li>
<li><p><strong>webIDE层</strong></p>
<p>嵌入了我们常用的 IDE 。像前面提到的vscode浏览器端的 code-server ，还有 jetbrains 系列，这一层后期可以根据开发同学的习惯使用进行拓展。</p>
</li>
<li><p><strong>语言环境层</strong></p>
<p>目前支持 node.js ，后续如果想支持后端，也可以扩展 java 等等的语言支持能力。</p>
</li>
<li><p><strong>操作系统层</strong></p>
<p>centos 和 ubuntu 。</p>
</li>
</ol>
<p>分层的好处在于共享资源，比如说有很多的镜像，可以从 base 镜像构建而来。所以最终的镜像其实是由这四层基础镜像交叉组合成的一个镜像，便于多语言环境、多 IDE 类型、多业务场景以及多操作系统的扩展。</p>
<ul>
<li><strong>小结</strong></li>
</ul>
<p>有了以上的方案以及实现，我们就可以进行代码编写、运行、debug 、push 等等一系列常规操作。</p>
<h3 id="5-3-5-核心难点及解决方案"><a href="#5-3-5-核心难点及解决方案" class="headerlink" title="5.3.5    核心难点及解决方案"></a>5.3.5    核心难点及解决方案</h3><p>在使用云开发的过程中，我们也遇到了一些问题。比如：</p>
<ol>
<li><p><strong>资源利用率低</strong></p>
<p>创建的云环境太多，导致机器资源利用率并不高。对于公司成本节约就造成了一定的压力。</p>
</li>
<li><p><strong>没有打通开发的全流程</strong></p>
<p>虽然说现在可以写代码了，但是没和其他平台做一个整合，开发流程还是很分散。</p>
</li>
<li><p><strong>无法实现个性化配置</strong></p>
<p>我们想安装自己的插件和配置，在当前云环境内是可更改的，但一旦创建一个新的云环境是不生效的。那这种情况与本地开发相比，在开发体验上还不能完全本地化和可定制化。</p>
</li>
</ol>
<p>于是针对于这些问题，我们也做了以下几个方面的工作去解决。</p>
<ul>
<li>提高资源利用率-弹性伸缩，建立定期清理 webIDE 的机制</li>
</ul>
<ol>
<li><p><strong>超时回收</strong></p>
<p>达到不在线的超时时间，比如4小时，即会释放 cpu、内存资源，但 IDE 的配置和已拉取的项目仍持久保存，下次可直接使用。</p>
</li>
<li><p><strong>彻底销毁</strong></p>
<p>彻底销毁会将持久化的代码资源和配置都删除。</p>
</li>
</ol>
<p>当 webIDE 容器达到不在线的过期销毁时间（现在设置的是7天），会先给用户发 IM 消息提示，提示中已给出 IDE 的各项信息，如确认不需要使用忽略消息即可，如仍需使用，按照提示操作即可保留 IDE 。</p>
<ul>
<li>打通开发全流程</li>
</ul>
<p>我们希望除了能实现在浏览器的开发，更希望通过浏览器和公司内其他产品流程结合起来，打通开发的全流程，真正建立研发效能的闭环。对于开发同学来说，下图5-27就是项目开发的完整链路。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/05.jpg" alt=""></p>
<center>图5-27 使用云开发进行项目开发完整链路</center>

<p>从 pmo 创建 -&gt; 项目创建 -&gt; 项目开发 -&gt; 代码提交 -&gt; 代码发布 -&gt;  pmo 关闭。其中项目打开 -&gt; 项目开发 -&gt; 代码提交这三个阶段可以交由 webIDE 中操作。其他流程这里举两个例子：</p>
<ol>
<li>关联 pmo：可以在创建云开发环境关联绑定 pmo 号，而在关闭 pmo 的时候销毁这个环境。</li>
<li>代码发布：也可以打通 CI、CD 。这块已经实现打通了发布平台，我们后面来详细阐述。</li>
</ol>
<ul>
<li>打通开发全流程-易扩展</li>
</ul>
<p>对于团队需要的 WebIDE，满足日常的开发是必须的。所以易扩展，一定是排在第一位的。所以基于此，我们在插件中，实现了打通全流程中的一环—打通CI/CD 。下图5-28是我们给云环境定制化的一款插件。插件整体分为四个版块。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/06.png" alt=""></p>
<center>图5-28 WEBIDE</center>

<ol>
<li><p><strong>常用命令</strong></p>
<p>这个就是便利了开发同学，不需要大家打开终端执行命令，而是点击即可自动打开终端执行。除了默认的常用命令，我们还推出了自定义按钮执行脚本的模式，让业务线同学定制化运行程序，参与云开发共建。</p>
</li>
<li><p><strong>发布版块</strong></p>
<p>也就是我们打通 CI/CD 的一环。这部分会根据打开的文件目录自动识别发布类型，不需要开发同学去发布平台查找以及填写发布表单，即可一键关联发布平台。</p>
</li>
<li><p><strong>个性化定制</strong></p>
<p>用户可定制安装属于自己的插件，设置后，在新创建的云环境上都是生效的。</p>
</li>
<li><p><strong>用户个性化配置</strong></p>
<p>针对于开发体验这块，我们也是尽量保证在浏览器端大家也能有一个本地化的开发体验，那对于 vscode 来说，插件是必不可少的。我们把插件分为三种类型：</p>
<ul>
<li><p>通用插件。比如说中文语言包、深色主题等等</p>
</li>
<li><p>面向业务场景的插件。比如说node场景的eslint语法检查插件、react等等的一些开发提示插件</p>
</li>
<li><p>支持用户个性化的去定制配置和插件。前两类都是在镜像中内置好的，而这类型插件是在创建云环境的时候去动态设置的，能最大程度的接近本地化。</p>
</li>
</ul>
</li>
</ol>
<ul>
<li><strong>小结</strong></li>
</ul>
<p>至此，优化完以上问题，webide 本身已经非常完美了，但是在开发体验上还是只能近似接近本地化，还是有一些缺失。比如说在一些快捷键的使用上，因为和 chrome 本身有一些冲突。如果在快捷键体验上要求比较高的同学，那我们也提供了另一种方式。</p>
<h3 id="5-3-6-localIDE模式"><a href="#5-3-6-localIDE模式" class="headerlink" title="5.3.6    localIDE模式"></a>5.3.6    localIDE模式</h3><p>也称为本地 ide 连接远端容器模式。如下图5-29。</p>
<p><img src="/rdefficiency/medias/images/cloudbase/07.png" alt=""></p>
<center>图5-29 本地连接远端容器</center>

<p>可以看到，与先前我们看到的整体架构图相比，在 localOS 处由原来的浏览器通过 https 访问变成了由本地的 IDE 通过 ssh 通道连接到 server 端。</p>
<p>这个过程中，只传输代码、索引等数据，仅将计算匀给服务器，而渲染显示等还是依赖本地的 IDE 客户端，这种情况下，我们就能完全拥有本地化的开发体验。</p>
<h3 id="5-3-7-总结规划"><a href="#5-3-7-总结规划" class="headerlink" title="5.3.7    总结规划"></a>5.3.7    总结规划</h3><ul>
<li>总结</li>
</ul>
<p>下图5-30是我们一个核心团队反馈的各个阶段使用云开发前后的时间对比及效率提升。<br><img src="/rdefficiency/medias/images/cloudbase/08.jpg" alt=""></p>
<center>图5-30 效果收益</center>

<p>整体而言，对于首次启动并开发的项目来说，云开发效率可以提升80%，对于日常开发、查问题这种业务场景，效率能提升60%。可以看出，在云开发结合打通全流程这一块，对于效率的提升起到了较大的作用。</p>
<p>云开发是我们运用云原生理念和技术在开发提效方向的探索，之前可能我们更多的关注于测试运维阶段，因为这些阶段的复杂度相对来说较高，因此更需要自动化、工具化，然而当基本建设完成之后我们再次盘点完整链路和深入挖掘痛点，开发同学这个庞大的用户群里的效率和质量应该是我们关注的重点。</p>
<ul>
<li>规划</li>
</ul>
<p>对于云开发未来的规划，主要分为三个方向。</p>
<ol>
<li><p><strong>横向扩展</strong></p>
<p>适配公司内更多的业务场景</p>
</li>
<li><p><strong>继续优化体验、丰富功能</strong></p>
<ul>
<li>比如提升不同场景环境管理功能，让该业务场景的管理员能自己改变镜像中设定的的某些依赖。</li>
<li>创建独立的云开发管理平台。</li>
<li>稳定性运维。</li>
</ul>
</li>
<li><p><strong>推广工作</strong></p>
<p>云开发模式上线后，一些业务已经在上面开发。不过更多的开发同学还是持有保守态度，后续会继续提升开发体验，让更多同学接受这种新型的开发模式。</p>
</li>
</ol>

            </div>
            <hr />

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《Part 3 开发提效》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/rdefficiency/3-develop/" property="cc:attributionName"
               rel="cc:attributionURL">
                北京趣拿软件科技有限公司 ｜ 基础架构
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    
    <link rel="stylesheet" href="/rdefficiency/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/rdefficiency/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/rdefficiency/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'ed98d39f94ff459ee228',
        clientSecret: '9d04488d8bba75646a9ff2d97092c7379b796690',
        repo: 'rdefficiency',
        owner: 'qunarcorp',
        admin: "zhangcf945",
        id: '3-develop/',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    
    <div class="disqus-card card" data-aos="fade-up">
    <div id="disqus_thread" class="card-content">
        <noscript>Please enable JavaScript to view the
            <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
    </div>
</div>

<script type="text/javascript">
    disqus_config = function () {
        this.page.url = 'https://qunarcorp.github.io/rdefficiency/3-develop/';
        this.page.identifier = '/3-develop/';
        this.page.title = 'Part 3 开发提效';
    };
    let disqus_shortname = '';

    (function () { // DON'T EDIT BELOW THIS LINE
        let d = document, s = d.createElement('script');
        // 如：s.src = 'https://blinkfox.disqus.com/embed.js';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/rdefficiency/2-service/">
                    <div class="card-image">
                        
                        
                        <img src="/rdefficiency/medias/featureimages/cover.jpg" class="responsive-img" alt="Part 2 服务化建设">
                        
                        <span class="card-title">Part 2 服务化建设</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            介绍架构的几个重要模式以及去哪儿网的微服务架构实现，同时包含servicemesh探索和基于架构的开发效率提升实践：Spring Cloud Qunar和开发插件
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2022-10-10
                        </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/rdefficiency/tags/%E6%9C%8D%E5%8A%A1%E5%8C%96/" target="_blank">
                        <span class="chip bg-color">服务化</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/rdefficiency/4-quality/">
                    <div class="card-image">
                        
                        
                        <img src="/rdefficiency/medias/featureimages/cover.jpg" class="responsive-img" alt="Part 4 质量保障">
                        
                        <span class="card-title">Part 4 质量保障</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            介绍研发过程的质量保障手段，包括灵活的环境管理方案、高效的自动化测试平台、完善的覆盖率保障方案。
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2022-10-10
                            </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/rdefficiency/tags/%E8%B4%A8%E9%87%8F%E4%BF%9D%E9%9A%9C/" target="_blank">
                        <span class="chip bg-color">质量保障</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 去哪儿旅行<br />'
            + '作者: 北京趣拿软件科技有限公司 ｜ 基础架构<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归去哪儿旅行所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/rdefficiency/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4, h5, h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5, h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>


    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 北京趣拿软件科技有限公司. 版权所有

            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">133.6k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
            <br>
            
            <span id="busuanzi_container_site_pv" style='display:none'>
                <i class="fa fa-heart-o"></i>
                本站总访问量 <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
            <span id="busuanzi_container_site_uv" style='display:none'>
                人次,&nbsp;访客数 <span id="busuanzi_value_site_uv" class="white-color"></span> 人.
            </span>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/qunarcorp" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:infra@qunar.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>









    <a href="/rdefficiency/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 0;
        var uvcountOffset = 0;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2022, 10, 10, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/rdefficiency/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/rdefficiency/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/rdefficiency/libs/materialize/materialize.min.js"></script>
    <script src="/rdefficiency/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/rdefficiency/libs/aos/aos.js"></script>
    <script src="/rdefficiency/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/rdefficiency/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/rdefficiency/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->



    

    
    <script async src="/rdefficiency/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 雪花特效 -->
    

</body>

</html>